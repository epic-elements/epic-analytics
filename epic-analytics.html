<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="segment.html">
<link rel="import" href="object-observe.html">
<link rel="import" href="../epic-rx/epic-rx.html">

<!--
`epic-analytics`
Adds analytics support powered by Segment.

Example:
    `<epic-analytics key="abcd1234e5f6g7xyz"></epic-analytics>`

@demo demo/index.html
-->

<dom-module id="epic-analytics">
  <template>
    <h2>Epic Analytics</h2>
    <h3>Segment ID: [[segmentKey]]</h3>
    <a href="#">Click me</a>
  </template>

  <script>
    (function() {
      'use strict';

      class EpicAnalytics {
        // Element setup goes in beforeRegister instead of createdCallback.
        beforeRegister() {
          this.is = 'epic-analytics';

          this.observable = new Rx.Subject();

          // Define the properties object in beforeRegister.
          this.properties = {
            /**
             * Specifies the unique id for sending tracking events to segment.
             */
            segmentKey: {
              type: String,
              observer: '_segmentKeyChanged',
              notify: true,
              value: ''
            },
            /**
             * Specifies if pageview events should be fired automatically.
             */
            trackPages: {
              type: Boolean,
              value: false,
              notify: true,
              observer: '_trackPagesChanged'
            },
            /**
             * Specifies the `name` property for auto pageview tracking.
             * Has no effect if `trackPages` is not `true`.
             */
            pageName: {
              type: String,
              value: '',
              notify: true,
              observer: '_pageNameChanged'
            }
          };
          this.segmentKeyChanges = this.observable.filter(value => value.key === 'segmentKey')
            .distinctUntilChanged()
            .filter(property => property.value)
            .map(property => property.value);

          this.pageNameChanges = this.observable.filter(value => value.key === 'pageName')
            .distinctUntilChanged();
          this.trackPagesChanges = this.observable.filter(value => value.key === 'trackPages')
            .distinctUntilChanged()
            .filter(property => property.value);

          this.segmentKeyChanges.subscribe(value => {
            analytics.load(value);
          });

          Rx.Observable.combineLatest(this.pageNameChanges, this.trackPagesChanges)
            .subscribe(value => {
              console.log(value[0].value);
              analytics.page(value[0].value);
            });
        }

        /**
         * Applies the segment key to `epic-analytics` and loads the segment API.
         *
         * @param {String} newValue The current value of `segmentKey`.
         * @param {String} oldValue The previous value of `segmentKey`.
         */
        _segmentKeyChanged(newValue, oldValue) {
          this.observable.onNext({
            key: 'segmentKey',
            value: newValue
          });
        }

        /**
         * Fires a pageview event if `trackPages` is set.
         *
         * @param {String} newValue The current value of `trackPages`.
         * @param {String} oldValue The previous value of `trackPages`.
         */
        _trackPagesChanged(newValue, oldValue) {
          this.observable.onNext({
            key: 'trackPages',
            value: newValue
          });
        }

        /**
         * defines a value for the `name` property to send with automatic pageview events.
         *
         * @param {String} newValue The current value of `trackPages`.
         * @param {String} oldValue The previous value of `trackPages`.
         */
        _pageNameChanged(newValue, oldValue) {
          this.observable.onNext({
            key: 'pageName',
            value: newValue
          });
        }

        _camelCase(string) {
          return string.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase();
        }
        _kebobCase(string) {
          return string.replace(/-([a-z])/g, g => g[1].toUpperCase());
        }
      }

      // Register the element using Polymer's constructor.
      Polymer(EpicAnalytics);
    })();
  </script>
</dom-module>
